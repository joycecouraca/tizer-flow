<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TirzeFlow Pro</title>
    <!-- Tailwind para o Design -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs (Versão Compat - Mais estável para ficheiro único) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #f8fafc; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        .hidden { display: none; }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- Ecrã de Carregamento -->
    <div id="loader" class="h-screen flex flex-col items-center justify-center bg-white z-50 fixed inset-0">
        <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 text-[10px] font-black uppercase tracking-widest text-slate-400">A carregar TirzeFlow...</p>
    </div>

    <!-- Ecrã de Login -->
    <div id="login-screen" class="min-h-screen hidden flex-col items-center justify-center p-8 text-center bg-slate-50">
        <div class="bg-blue-600 p-6 rounded-[35px] shadow-2xl mb-8">
            <svg class="w-10 h-10 text-white fill-current" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
        </div>
        <h1 class="text-4xl font-black mb-2 italic tracking-tighter text-slate-900">TirzeFlow</h1>
        <p class="text-slate-400 mb-10 text-sm">Painel de Controlo Elite GIP.</p>
        <div id="auth-error" class="hidden mb-4 p-3 bg-red-100 text-red-600 text-[10px] font-bold rounded-xl uppercase">E-mail não autorizado.</div>
        <button id="btn-login" class="w-full max-w-xs bg-slate-900 text-white font-black py-5 rounded-[25px] shadow-xl active:scale-95 transition-all">ENTRAR COM GOOGLE</button>
    </div>

    <!-- App Principal -->
    <div id="app-screen" class="hidden max-w-md mx-auto min-h-screen pb-32 animate-in">
        <header class="p-6 flex justify-between items-center glass sticky top-0 z-40 border-b border-slate-100">
            <div class="flex items-center gap-3">
                <img id="user-photo" src="" class="w-10 h-10 rounded-full border-2 border-white shadow-sm" />
                <div>
                    <p id="user-name" class="font-black text-sm leading-tight text-slate-900"></p>
                    <p class="text-[9px] text-emerald-500 font-bold uppercase tracking-widest">GIP Elite Ativo</p>
                </div>
            </div>
            <button id="btn-logout" class="text-slate-300 font-bold text-xs uppercase">Sair</button>
        </header>

        <main class="p-5 space-y-6">
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-slate-900 p-6 rounded-[35px] text-white shadow-xl shadow-slate-200">
                    <p class="text-[10px] opacity-40 font-bold uppercase mb-1">Peso Atual</p>
                    <div class="text-3xl font-black italic tracking-tighter"><span id="current-weight">--</span> <span class="text-xs opacity-40">kg</span></div>
                </div>
                <div class="bg-white p-6 rounded-[35px] border shadow-sm">
                    <p class="text-[10px] text-emerald-500 font-bold uppercase mb-1">Eliminado</p>
                    <div id="total-lost" class="text-3xl font-black text-emerald-500 italic tracking-tighter">0.0</div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-[35px] border shadow-sm">
                <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Ranking da Comunidade</h3>
                <div id="ranking-list" class="space-y-4">
                    <!-- Dinâmico -->
                </div>
            </div>
        </main>

        <!-- Botão Flutuante -->
        <button id="btn-open-modal" class="fixed bottom-28 right-6 w-16 h-16 bg-blue-600 text-white rounded-[24px] shadow-2xl flex items-center justify-center z-40 border-4 border-white active:scale-90 transition-all">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"/></svg>
        </button>

        <!-- Navegação -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t px-12 pt-4 pb-10 flex justify-around z-30">
            <button class="text-blue-600"><svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24"><path d="M4 13h6c.55 0 1-.45 1-1V4c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v8c0 .55.45 1 1 1zm0 8h6c.55 0 1-.45 1-1v-4c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v4c0 .55.45 1 1 1zm10 0h6c.55 0 1-.45 1-1v-8c0-.55-.45-1-1-1h-6c-.55 0-1 .45-1 1v8c0 .55.45 1 1 1zM14 4v4c0 .55.45 1 1 1h6c.55 0 1-.45 1-1V4c0-.55-.45-1-1-1h-6c-.55 0-1 .45-1 1z"/></svg></button>
            <button class="text-slate-200"><svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg></button>
        </nav>
    </div>

    <!-- Modal de Registo -->
    <div id="modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 hidden flex items-end">
        <div class="bg-white w-full rounded-t-[45px] p-8 space-y-6 shadow-2xl">
            <h2 class="text-2xl font-black italic">Novo Registo</h2>
            <form id="weight-form" class="space-y-4">
                <input id="input-weight" type="number" step="0.1" class="w-full bg-slate-50 p-6 rounded-[25px] font-black text-3xl outline-none" placeholder="00.0" required>
                <button type="submit" class="w-full bg-slate-900 text-white py-6 rounded-[25px] font-black shadow-xl">Confirmar</button>
            </form>
            <button id="btn-close-modal" class="w-full text-slate-300 text-xs font-bold pb-4">CANCELAR</button>
        </div>
    </div>

    <script>
        // CONFIGURAÇÃO
        const firebaseConfig = {
            apiKey: "AIzaSyAXzHCgk3u7_p0GNfjsfUWrwz6WTyJJqkg",
            authDomain: "tirzeflow.firebaseapp.com",
            projectId: "tirzeflow",
            storageBucket: "tirzeflow.firebasestorage.app",
            messagingSenderId: "99575407392",
            appId: "1:99575407392:web:cf8ff44f2092590e48ed45"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const provider = new firebase.auth.GoogleAuthProvider();
        const appId = 'tirzeflow-pro';

        const loader = document.getElementById('loader');
        const loginScreen = document.getElementById('login-screen');
        const appScreen = document.getElementById('app-screen');
        const authError = document.getElementById('auth-error');

        let currentUser = null;
        let records = [];

        // MONITORIZAÇÃO DE ESTADO
        auth.onAuthStateChanged(async (user) => {
            loader.classList.add('hidden');
            if (user) {
                const email = user.email.toLowerCase();
                const authDoc = await db.doc(`artifacts/${appId}/public/data/authorized_users/${email}`).get();
                
                if (authDoc.exists) {
                    currentUser = user;
                    setupApp();
                } else {
                    authError.classList.remove('hidden');
                    auth.signOut();
                }
            } else {
                loginScreen.classList.remove('hidden');
                appScreen.classList.add('hidden');
            }
        });

        // INICIALIZAÇÃO DA APP
        function setupApp() {
            loginScreen.classList.add('hidden');
            appScreen.classList.remove('hidden');
            document.getElementById('user-name').innerText = currentUser.displayName.split(' ')[0];
            document.getElementById('user-photo').src = currentUser.photoURL;

            // Escuta de Dados Pessoais
            db.collection(`artifacts/${appId}/users/${currentUser.uid}/tracking`)
                .onSnapshot(snap => {
                    records = snap.docs.map(d => d.data()).sort((a,b) => a.semana - b.semana);
                    if (records.length > 0) {
                        const last = records[records.length-1];
                        document.getElementById('current-weight').innerText = last.peso;
                        document.getElementById('total-lost').innerText = `-${(records[0].peso - last.peso).toFixed(1)}kg`;
                    }
                });

            // Escuta de Ranking
            db.collection(`artifacts/${appId}/public/data/ranking`)
                .onSnapshot(snap => {
                    const list = document.getElementById('ranking-list');
                    list.innerHTML = '';
                    const sorted = snap.docs.map(d => d.data()).sort((a,b) => b.totalPerdido - a.totalPerdido);
                    
                    sorted.forEach((p, i) => {
                        const div = document.createElement('div');
                        div.className = "flex items-center justify-between p-3 border-b border-slate-50 last:border-0";
                        div.innerHTML = `
                            <div class="flex items-center gap-3">
                                <span class="text-[10px] font-black text-slate-300">#${i+1}</span>
                                <img src="${p.foto}" class="w-8 h-8 rounded-full">
                                <span class="text-sm font-bold text-slate-800">${p.nome}</span>
                            </div>
                            <div class="text-emerald-500 font-black text-xs">-${p.totalPerdido}kg</div>
                        `;
                        list.appendChild(div);
                    });
                });
        }

        // EVENTOS
        document.getElementById('btn-login').onclick = () => auth.signInWithPopup(provider);
        document.getElementById('btn-logout').onclick = () => auth.signOut();
        document.getElementById('btn-open-modal').onclick = () => document.getElementById('modal').classList.remove('hidden');
        document.getElementById('btn-close-modal').onclick = () => document.getElementById('modal').classList.add('hidden');

        document.getElementById('weight-form').onsubmit = async (e) => {
            e.preventDefault();
            const weight = parseFloat(document.getElementById('input-weight').value);
            const semana = records.length + 1;
            
            await db.doc(`artifacts/${appId}/users/${currentUser.uid}/tracking/sem-${semana}`).set({
                semana, peso: weight, data: new Date().toISOString()
            });

            const pInicial = records.length > 0 ? records[0].peso : weight;
            await db.doc(`artifacts/${appId}/public/data/ranking/${currentUser.uid}`).set({
                uid: currentUser.uid, nome: currentUser.displayName, foto: currentUser.photoURL,
                pesoAtual: weight, totalPerdido: parseFloat((pInicial - weight).toFixed(1))
            });

            document.getElementById('modal').classList.add('hidden');
            document.getElementById('input-weight').value = '';
        };
    </script>
</body>
</html>

